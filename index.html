<!DOCTYPE html>
<html>
<head>
    <script src="node_modules/simplewebrtc/latest-v2.js"></script>
    <script src="jquery-3.1.1.min.js"></script>
    <script src="node_modules/page/page.js"></script>
    <script src="handlebars.runtime.min.js"></script>
    <script src="calling-buttons.min.js"></script>
</head>
<body>


<input type="text" id="username">
<button id="submit">Submit</button>
<button id="leave">Leave</button>
<button id="page">page</button>
<video height="300" id="localVideo"></video>
<div id="remotesVideos"></div>

<div id="peers"></div>

<script>


    var allPeers = [];
    var peerInfo = {};
    var webrtc = null;

    page('/activePage/:roomname', handlePageChange);

    $('#page').click(function () {
        page('/active?test');
    });
    $('#submit').click(function () {


        var username = $('#username').val();
        peerInfo.username = username;
        webrtc = new SimpleWebRTC({

            url: 'https://' + location.hostname + ":8888",
            autoRequestMedia: true,
            nick: username
        });

        webrtc.on('readyToCall', function () {
                webrtc.joinRoom('idle');
                webrtc.mute();
        });

        webrtc.on('createdPeer', function (peer) {
            allPeers = webrtc.getPeers();
            setTimeout(function () {
                allPeers.map(function (peer) {
                    return {nick: peer.nick, id: peer.id}
                });
                var peerListTemplate = Handlebars.templates['calling-buttons']({'allPeers': allPeers});
                $('#peers').html(peerListTemplate);
                register();
            }, 1000);
        });

        webrtc.connection.on('remove', function(obj) {
            allPeers=webrtc.getPeers().map(function (peer) {
                return {nick:peer.nick,id:peer.id}
            });
            var peerListTemplate = Handlebars.templates['calling-buttons']({'allPeers':JSON.parse(JSON.stringify(allPeers))});
            $('#peers').html(peerListTemplate);
            register();
        });

        $('#leave').click(function () {
            webrtc.sendToAll('left', peerInfo);
            webrtc.leaveRoom();
        });

        function register() {
            $('.call').click(function () {
                console.log($(this).data('session'));
                webrtc.sendToAll('calling',{'receiver':$(this).data('session'),'sender':webrtc.connection.connection.id})
            });
        }

        webrtc.connection.on('message', function (data) {
            if (data.type == 'calling') {
                if (data.payload.receiver == webrtc.connection.connection.id) {
                    var acc = confirm('Call from ' + data.payload.sender);
                    if (acc) {
                        webrtc.createRoom(data.payload.sender, function () {
                            webrtc.sendToAll('accepted', data.payload.sender);
                            page('/activePage/' + data.payload.sender);
                        });
                    }
                    console.log('calling');
                }
            }
            if (data.type == 'accepted') {
                if (data.payload == webrtc.connection.connection.id) {
                    page('/activePage/' + data.payload);
                }
            }
        });

    });

    function handlePageChange(ctx) {
        webrtc.leaveRoom();
        webrtc.joinRoom(ctx.params.roomname || 'idle');
        webrtc.unmute();
        $('#peers').hide();
    }


</script>
</body>
</html>